{% extends "layout.html" %} {% block content %}

<section class="menu-search-box">
    <div class="menu-search-container">
        <div class="details">
            <p>
                <svg xmlns="http://www.w3.org/2000/svg" width="37" height="37" viewBox="0 0 512 512">
                    <path fill="#fff" fill-rule="evenodd"
                        d="M256 42.667C138.18 42.667 42.667 138.179 42.667 256c0 117.82 95.513 213.334 213.333 213.334c117.822 0 213.334-95.513 213.334-213.334S373.822 42.667 256 42.667m0 384c-94.105 0-170.666-76.561-170.666-170.667S161.894 85.334 256 85.334c94.107 0 170.667 76.56 170.667 170.666S350.107 426.667 256 426.667m26.714-256c0 15.468-11.262 26.667-26.497 26.667c-15.851 0-26.837-11.2-26.837-26.963c0-15.15 11.283-26.37 26.837-26.37c15.235 0 26.497 11.22 26.497 26.666m-48 64h42.666v128h-42.666z" />
                </svg>
                รับหน้าร้านเท่านั้น - สั่งล่วงหน้าอย่างน้อย 15 นาที
            </p>
        </div>
        <div class="menu-search-list">
            <ul class="cagatory-menu">
                <li class="cagatory active" data-target="all">ทั้งหมด</li>
                <li class="cagatory" data-target="coffee">กาแฟ</li>
                <li class="cagatory" data-target="tea">ชา</li>
                <li class="cagatory" data-target="food">ของคาว</li>
                <li class="cagatory" data-target="dessert">ของหวาน</li>
            </ul>
        </div>
        {% if is_admin %}
        <div class="bg-black" id="bgblack"></div>
        <div class="popup-form" id="popup">
            <form action="/add-menu" method="post" enctype="multipart/form-data" class="add" id="add_id">
                <h3 style="font-size: 20px; color: #583e2c; margin-bottom: 1rem">
                    เพิ่มเมนู
                </h3>
                <label for="file" class="add-file">
                    <div class="container-file">
                        <div class="ic-upload">
                            <svg id="icon-up" xmlns="http://www.w3.org/2000/svg" width="65" height="65"
                                viewBox="0 0 24 24">
                                <g fill="none" stroke="#808080" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2">
                                    <path stroke-dasharray="20" stroke-dashoffset="20"
                                        d="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5">
                                        <animate attributeName="d" begin="0.5s" dur="1.5s" repeatCount="indefinite"
                                            values="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5;M12 15h2v-3h2.5l-4.5 -4.5M12 15h-2v-3h-2.5l4.5 -4.5;M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5" />
                                        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s"
                                            values="20;0" />
                                    </path>
                                    <path stroke-dasharray="14" stroke-dashoffset="14" d="M6 19h12">
                                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.2s"
                                            values="14;0" />
                                    </path>
                                </g>
                            </svg>
                        </div>
                        <img id="img-suc" style="
                display: none;
                justify-self: center;
                max-width: 280px;
                max-height: 50px;
              " src="" alt="" />
                        <h3>เพิ่มภาพประกอบเมนู</h3>
                        <p>** แนะนำ สูง220px กว้าง480px **</p>
                    </div>
                </label>
                <input type="file" name="menu_image" style="margin-bottom: 1rem; display: none" id="file"
                    accept="image/*" required />
                <label for="text-menu">ชื่อเมนู</label>
                <input type="text" id="text-menu" name="menu_name" placeholder="ชื่อเมนู" class="input-add" required />
                <label for="number-price">ราคา</label>
                <input type="number" id="number-price" name="menu_price" placeholder="ราคา" class="input-add"
                    required />
                <textarea name="detail-menu-add" class="detail-menu-add" id="" placeholder="พิมพ์รายละเอียด"></textarea>
                <div class="checkbox">
                    <label><input type="checkbox" name="option_type" value="1" /> ร้อน</label>
                    +
                    <input type="number" name="option_type_1" style="width: 25px; padding-left: 0.25rem" />
                    <label><input type="checkbox" name="option_type" value="2" /> เย็น</label>
                    +
                    <input type="number" name="option_type_2" style="width: 25px; padding-left: 0.25rem" />
                    <label><input type="checkbox" name="option_type" value="3" /> ปั่น</label>
                    +
                    <input type="number" name="option_type_3" style="width: 25px; padding-left: 0.25rem" />
                </div>
                <div class="checkbox">
                    <label><input type="checkbox" name="sweetness" value="หวานมาก" />
                        หวานมาก</label>
                    <label><input type="checkbox" name="sweetness" value="หวานปกติ" />
                        หวานปกติ</label>
                    <label><input type="checkbox" name="sweetness" value="หวานน้อย" />
                        หวานน้อย</label>
                    <label><input type="checkbox" name="sweetness" value="ไม่หวาน" />
                        ไม่หวาน</label>
                </div>

                <select name="cagatories-add" id="option-add">
                    <option value="">กรุณาเลือกหมวด</option>
                    <option value="coffee">กาแฟ</option>
                    <option value="tea">ชา</option>
                    <option value="food">ของคาว</option>
                    <option value="dessert">ของหวาน</option>
                </select>
                <button type="submit" id="add-list-menu">เพิ่มเมนู</button>
                <button type="button" id="del-popup">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 14 14">
                        <path fill="#808080" fill-rule="evenodd"
                            d="M1.707.293A1 1 0 0 0 .293 1.707L5.586 7L.293 12.293a1 1 0 1 0 1.414 1.414L7 8.414l5.293 5.293a1 1 0 0 0 1.414-1.414L8.414 7l5.293-5.293A1 1 0 0 0 12.293.293L7 5.586z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </form>
        </div>
        {% endif %}
        <div class="menu-search">
            <input type="text" placeholder="ค้นหาเมนู..." id="search" />
            <span class="icon-search"><svg id="searchBtn" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24">
                    <path fill="#B5B5B5"
                        d="M9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l5.6 5.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275l-5.6-5.6q-.75.6-1.725.95T9.5 16m0-2q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" />
                </svg></span>
        </div>
    </div>
</section>
<!-- โหลด library ก่อน -->


<section class="list-store-menu">
    <div id="menuModal" class="modal" data-menu-id="">
        <div class="modal-content">
            <div class="cntainer">
                <h3 class="modal-name" style="color: #7c5e48">ชื่อเมนู</h3>
                <p class="close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 40 40">
                        <path fill="#333"
                            d="M21.499 19.994L32.755 8.727a1.064 1.064 0 0 0-.001-1.502c-.398-.396-1.099-.398-1.501.002L20 18.494L8.743 7.224c-.4-.395-1.101-.393-1.499.002a1.05 1.05 0 0 0-.309.751c0 .284.11.55.309.747L18.5 19.993L7.245 31.263a1.064 1.064 0 0 0 .003 1.503c.193.191.466.301.748.301h.006c.283-.001.556-.112.745-.305L20 21.495l11.257 11.27c.199.198.465.308.747.308a1.06 1.06 0 0 0 1.061-1.061c0-.283-.11-.55-.31-.747z" />
                    </svg>
                </p>
            </div>

            <!-- ปุ่ม option (ร้อน/เย็น/ปั่น) จะมาวางตรงนี้ -->
            <div class="options"></div>
            <div class="sweetness-options">
                <!-- radio จะ generate จาก JSON ที่เก็บไว้ -->
            </div>
            <div class="quantity-box">
                <div class="dv">
                    <button id="decreaseQty">-</button>
                    <span id="quantity">1</span>
                    <button id="increaseQty">+</button>
                </div>
                <p style="color: #7c5e48; font-weight: bolder; font-size: 18px">
                    <span id="price">0</span> ฿
                </p>
            </div>

            <button id="addToCart">เพิ่มลงตะกร้า</button>
        </div>
    </div>
    <div class="list-store-con" id="menu-list"></div>
</section>



<script>
    let allOptions = []; // เก็บ options ทั้งหมดจาก API
    let cart = JSON.parse(localStorage.getItem("cart")) || []; // ตะกร้า

    // ======== Fetch เมนู ========
    fetch("api/menus")
        .then((res) => res.json())
        .then((data) => {
            allOptions = data.options;
            const menulist = document.getElementById("menu-list");
            menulist.innerHTML = "";

            data.menus.forEach((menu) => {
                let listOptHTML = "";
                data.menu_option_prices
                    .filter((opt) => opt.id_menu == menu.id_menu)
                    .forEach((optMenu) => {
                        const optData = data.options.find(
                            (o) => o.id_option == optMenu.id_option
                        );
                        if (optData) {
                            const add = optMenu.price_add ? ` +${optMenu.price_add}` : "";
                            listOptHTML += `<li>${optData.option_name}${add}</li>`;
                        }
                    });

                // ถ้าเป็นแอดมินให้มีปุ่มลบ
                let buttonDel = "";
                if (data.is_admin === true) {
                    buttonDel = `
                    <button class="delAdmin" data-id="${menu.id_menu}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                            <path fill="#fff" d="m9.4 16.5l2.6-2.6l2.6 2.6l1.4-1.4l-2.6-2.6L16 9.9l-1.4-1.4l-2.6 2.6l-2.6-2.6L8 9.9l2.6 2.6L8 15.1zM7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21z"/>
                        </svg>
                    </button>`;
                }
                const box = document.createElement("div");
                box.className = `list-store-box ${menu.category}`;
                box.innerHTML = `
                <div class="img-menu">
                    ${buttonDel}
                    <img src="${menu.img_path}" alt="">
                </div>
                <div class="detail-all">
                    <div class="name-price">
                        <h3 class="name-menu">${menu.menu_name}</h3>
                        <h3 class="price-menu">${menu.menu_price
                    } <span>฿</span></h3>
                    </div>
                    <p class="detail-menu">${menu.details}</p>
                    <div class="option-add">
                        <ul class="option-menu">${listOptHTML}</ul>
                        <button class="add-menu" 
                            data-id="${menu.id_menu}" 
                            data-name="${menu.menu_name}"
                            data-price="${menu.menu_price}"
                            data-sweetness='${JSON.stringify(
                        menu.sweetness || []
                    )}'

                            data-options='${JSON.stringify(
                        data.menu_option_prices.filter(
                            (opt) => opt.id_menu == menu.id_menu
                        )
                    )}'>
                            เพิ่ม
                        </button>


                    </div>
                </div>
            `;
                menulist.appendChild(box);
            });
        });
    updateCartUI();
    // ======== กดปุ่มลบเมนู (Admin) ========
    document.getElementById("menu-list").addEventListener("click", (e) => {
        if (e.target.closest(".delAdmin")) {
            const id = e.target.closest(".delAdmin").dataset.id;
            if (confirm("ต้องการลบเมนูนี้ใช่หรือไม่?")) {
                fetch(`api/delete_menu/${id}`, { method: "DELETE" })
                    .then((res) => res.json())
                    .then((result) => {
                        alert(result.message || "ลบเมนูแล้ว");
                        location.reload();
                    })
                    .catch((err) => console.error("Delete failed:", err));
            }
        }
    });

    // ======== Modal เมนู ========
    document.getElementById("menu-list").addEventListener("click", (e) => {
        if (e.target.classList.contains("add-menu")) {
            const modal = document.getElementById("menuModal");
            const name = e.target.dataset.name;
            const basePrice = parseInt(e.target.dataset.price);
            const options = JSON.parse(e.target.dataset.options);
            const priceEl = modal.querySelector("#price");
            const quantityEl = modal.querySelector("#quantity");
            const sweetness = JSON.parse(e.target.dataset.sweetness || "[]");

            const menuId = e.target.dataset.id;
            modal.dataset.menuId = menuId;

            const sweetBox = modal.querySelector(".sweetness-options");
            sweetBox.innerHTML = "";
            if (sweetness.length > 0) {
                let sweetHTML = sweetness
                    .map(
                        (s, i) => `
        <label style="display:block; margin:4px 0;">
            <input type="radio" name="sweetness_${e.target.dataset.id
                            }" value="${s}" ${i === 0 ? "checked" : ""}>
             ${s}
        </label>
    `
                    )
                    .join("");
                sweetBox.innerHTML = sweetHTML;
                sweetBox.querySelectorAll("label").forEach((label) => {
                    const input = label.querySelector("input[type='radio']");

                    // ถ้า checked ให้ active
                    if (input.checked) label.classList.add("active");

                    // ใส่ listener toggle
                    label.addEventListener("click", () => {
                        sweetBox
                            .querySelectorAll("label")
                            .forEach((l) => l.classList.remove("active"));
                        label.classList.add("active");
                        input.checked = true;
                    });
                });

                const firstLabel = sweetBox.querySelector("label input:checked");
                if (firstLabel) firstLabel.closest("label").classList.add("active");
            }

            let selectedQty = 1;
            let selectedOptionAdd = 0;

            // อัปเดตราคา
            const updatePrice = () => {
                priceEl.innerText = (basePrice + selectedOptionAdd) * selectedQty;
            };

            modal.querySelector(".modal-name").innerText = name;
            quantityEl.innerText = selectedQty;

            // quantity
            modal.querySelector("#increaseQty").onclick = () => {
                selectedQty++;
                quantityEl.innerText = selectedQty;
                updatePrice();
            };
            modal.querySelector("#decreaseQty").onclick = () => {
                if (selectedQty > 1) {
                    selectedQty--;
                    quantityEl.innerText = selectedQty;
                    updatePrice();
                }
            };

            // options
            const optBox = modal.querySelector(".options");
            optBox.innerHTML = "";
            if (options.length > 0) {
                options.forEach((opt) => {
                    const optData = allOptions.find((o) => o.id_option == opt.id_option);
                    if (optData) {
                        const btn = document.createElement("button");
                        btn.innerText =
                            optData.option_name +
                            (opt.price_add ? ` +${opt.price_add}฿` : "");
                        btn.classList.add("option-btn");
                        btn.dataset.add = opt.price_add;

                        btn.onclick = () => {
                            selectedOptionAdd = parseInt(opt.price_add);
                            updatePrice();
                            optBox
                                .querySelectorAll(".option-btn")
                                .forEach((b) => b.classList.remove("active"));
                            btn.classList.add("active");
                        };

                        optBox.appendChild(btn);
                    }
                });
                // เลือก option แรก
                optBox.querySelector(".option-btn").click();
            }

            updatePrice();
            modal.style.display = "block";
        }
    });

    // ปิด modal เมนู
    document.querySelector("#menuModal .close").onclick = () => {
        document.getElementById("menuModal").style.display = "none";
    };

    // ======== เพิ่มเมนูลงตะกร้า ========
    document.getElementById("addToCart").addEventListener("click", () => {
        const modal = document.getElementById("menuModal");
        const id_menu = parseInt(modal.dataset.menuId); // ต้องใส่ data-menu-id ใน modal
        const id_option = parseInt(modal.querySelector(".options .option-btn.active")?.dataset.optionId || 0);
        const name = modal.querySelector(".modal-name").innerText;
        const qty = parseInt(modal.querySelector("#quantity").innerText);
        const priceText = modal.querySelector("#price").innerText;
        const price = parseInt(priceText.replace(/[^0-9]/g, "")) / qty;
        const optionName =
            modal.querySelector(".options .option-btn.active")?.innerText || "";
        const selectedSweetness =
            modal.querySelector(".sweetness-options input:checked")?.value || "";

        cart.push({
            id_menu: id_menu,
            id_option: id_option,
            name: name,
            optionName: optionName,
            sweetness: selectedSweetness,
            qty: qty,   // <-- เปลี่ยนจาก qty เป็น quantity
            price: price
        });
        localStorage.setItem("cart", JSON.stringify(cart));

        updateCartUI();
        modal.style.display = "none";
    });


    // ======== Modal ตะกร้า ========
    function updateCartUI() {
        const cartList = document.getElementById("cart-list");
        const totalPriceEl = document.getElementById("total-price");
        const badge = document.getElementById("cart-badge");

        cartList.innerHTML = "";

        if (cart.length === 0) {
            const li = document.createElement("li");
            li.style.textAlign = "center";
            li.style.color = "#555";
            li.innerText = "ตะกร้าว่าง";
            cartList.appendChild(li);
            totalPriceEl.innerText = 0;

            badge.style.display = "none";
            badge.innerText = 0;
            return;
        }

        let total = 0;
        let totalQty = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.qty; // คำนวณทีละ item
            total += itemTotal;

            totalQty += item.qty;

            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";
            li.style.marginBottom = "8px";

            li.innerHTML = `
        <div>
            <div style="display:flex; align-items: flex-start;"><strong>${item.name}</strong></div>
            <div style="font-size:0.9em;color:#555;">${item.optionName} | ${item.sweetness
                } x ${item.qty}</div>
        </div>
        <div style="display:flex; flex-direction:row; align-items:center;">
            $${itemTotal} ฿
 ฿
            <button class="remove-item" data-index="${index}" style="margin-left:8px;"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="#E53E3E" d="M14.28 2a2 2 0 0 1 1.897 1.368L16.72 5H20a1 1 0 1 1 0 2l-.003.071l-.867 12.143A3 3 0 0 1 16.138 22H7.862a3 3 0 0 1-2.992-2.786L4.003 7.07L4 7a1 1 0 0 1 0-2h3.28l.543-1.632A2 2 0 0 1 9.721 2zm3.717 5H6.003l.862 12.071a1 1 0 0 0 .997.929h8.276a1 1 0 0 0 .997-.929zM10 10a1 1 0 0 1 .993.883L11 11v5a1 1 0 0 1-1.993.117L9 16v-5a1 1 0 0 1 1-1m4 0a1 1 0 0 1 1 1v5a1 1 0 1 1-2 0v-5a1 1 0 0 1 1-1m.28-6H9.72l-.333 1h5.226z"/></g></svg></button>
        </div>
    `;
            cartList.appendChild(li);
        });

        totalPriceEl.innerText = total;

        badge.style.display = "inline-block";
        badge.innerText = totalQty;

        cartList.querySelectorAll(".remove-item").forEach((btn) => {
            btn.onclick = () => {
                const i = parseInt(btn.dataset.index);
                cart.splice(i, 1);
                localStorage.setItem("cart", JSON.stringify(cart));
                updateCartUI();
            };
        });

        localStorage.setItem("cart", JSON.stringify(cart));
    }

    // เปิด/ปิด modal ตะกร้า
    document.querySelector(".basket .car-sell").onclick = (e) => {
        e.preventDefault();
        document.getElementById("cartModal").style.display = "block"; // เปิดเฉพาะตอนคลิก
        updateCartUI();
    };

    // ปิด modal ตะกร้า
    document.querySelector("#cartModal .close").onclick = () => {
        document.getElementById("cartModal").style.display = "none";
    };
    window.onclick = (e) => {
        // ปิด modal เมนู
        if (e.target.id === "menuModal") {
            document.getElementById("menuModal").style.display = "none";
        }

        // ปิด modal ตะกร้า
        if (e.target.id === "cartModal") {
            document.getElementById("cartModal").style.display = "none";
        }
    };



</script>

{% endblock %}